/**
Copyright 2023-2025, Brendan Andrew Rood
*/

/**
This file is part of the Rapid-Tree-Note / RTN program.

RTN is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

RTN is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License along with RTN. It is available at ./License/COPYING. Otherwise, see <https://www.gnu.org/licenses/#AGPL>
*/

// MINIFIED VERSION OF THE FILE OF THE SAME NAME IN THE `src` FOLDER
// MINIFIED WITH https://www.toptal.com/developers/javascript-minifier
// MINIFIED AT Sun Apr 20 17:04:43 CDT 2025

import{ProcessingTree as t}from"./treeparser.js";import{Formatter as e,ExecutiveFormatter as r}from"./format.js";class VirtualBuffer{constructor(t){this.ref=t,this.start=t.selectionStart,this.end=t.selectionEnd,this.state="UNLOCKED"}writeCarrat(){this.ref.selectionStart=this.start,this.ref.selectionEnd=this.end}readCarrat(){this.start=this.ref.selectionStart,this.end=this.ref.selectionEnd}moveCarrat(t){this.start+=t,this.end+=t,this.writeCarrat()}countCaretLeft(){var t=this.ref.value.substring(0,this.start).split("\n");return t[t.length-1].split("	").length-1}keyHandler(t,e){if(console.debug(t),void 0==t&&(t={key:"none"}),"LOCKED"==this.state){setTimeout(()=>{this.keyHandler(t,e)},10);return}if(this.readCarrat(),"Tab"==t.key){if(t.preventDefault(),this.start==this.end)f(this.ref.value,this.start)&&(this.ref.value=this.ref.value.substring(0,this.start)+"	"+this.ref.value.substring(this.end),this.moveCarrat(1));else{for(var r=this.start,s=this.end-1;"\n"!=this.ref.value.substring(r,r+1)&&r>0;)r--;for(;"\n"!=this.ref.value.substring(s,s+1)&&s>0;)s--;var i=[],a=r;for(i.push(r);a<s-1;)a++,"\n"==this.ref.value.substring(a,a+1)&&i.push(a);if(s!=r&&i.push(s),t.shiftKey){var n=0;for(var h of i)"	"==this.ref.value.substring(h+n+1,h+n+2)&&(this.ref.value=this.ref.value.substring(0,h+n+1)+""+this.ref.value.substring(h+n+2),n--,this.ref.selectionStart=h+n,this.ref.selectionEnd=h+n)}else{var n=0;for(var h of i)f(this.ref.value,h+n+1)&&(this.ref.value=this.ref.value.substring(0,h+n+1)+"	"+this.ref.value.substring(h+n+1),n++,this.ref.selectionStart=h+n,this.ref.selectionEnd=h+n)}}}if("Enter"==t.key&&(t.preventDefault(),function t(e,r){var s=e.substring(0,r).split("\n"),i=h(s[s.length-1])>0,a=e.split("\n")[s.length];null==a&&(a="PROCEED");var n=h(a)>0;return!0==i&&!0==n;function h(t){var e=t.match(/\S/gm);return null!=e?e.length:0}}(this.ref.value,this.start)&&this.start==this.end)){var u=this.countCaretLeft();this.ref.value=this.ref.value.substring(0,this.start)+"\n"+this.ref.value.substring(this.end),this.moveCarrat(1);for(var l=0;l<u;l++)this.ref.value=this.ref.value.substring(0,this.start)+"	"+this.ref.value.substring(this.end),this.moveCarrat(1);window.main.scrollToCaret(this.ref)}function f(t,e){var r=t.substring(0,e).split("\n").length,s=t.split("\n"),i=s[r-1],a="";s.length>1&&(a=s[r-2]);var n,h,u=f(i),l=f(a);if(i=(i=t.substring(0,e).split("\n"))[i.length-1],u<l+1&&(n=i,h=n.match(/([\S ]+)/g),!((h=null!=h?h[0].length:0)>0)))return!0;return!1;function f(t){if(""==t)return 0;var e=t.match(/^(\t*)/g);return null!=e?e[0].length:0}}this.state="LOCKED",setTimeout(()=>{e()},10)}update(){this.state="UNLOCKED",this.readCarrat()}}export class RawBuffer extends VirtualBuffer{constructor(t){super(t)}update(){this.ref.value=this.ref.value.replace(/[└├│─ ]*​/gm,"	"),this.ref.value=this.ref.value.replace(/(?:\t+[\S ]+)(\t+)/gm,"	"),super.update()}}export class ExeBuffer extends VirtualBuffer{constructor(e){super(e),this.tree=new t("")}update(){this.tree.input=this.ref.textContent,this.tree.totalParse();var t=this.tree.output;t=r.PARSE(t),this.ref.innerHTML=t,super.update()}}