/**
Copyright 2023, Brendan Andrew Rood
*/

/**
This file is part of the Rapid-Tree-Note / RTN program.

RTN is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

RTN is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License along with RTN. It is avalible at ./License/COPYING. Otherwise, see <https://www.gnu.org/licenses/>
*/

import{Line as t,Fork as e,Bend as s,Gap as r,Data as i,New as a,End as n,Null as l}from"./treeblocks.js";import{URIMannager as o}from"./URI-mannager.js";export default class h{constructor(t,e,s){this.maxURLLength=8192,this.uri=new o,window.main=this;var r=this.pullURL();this.raw=new RawBuffer(t),this.exe=new ExeBuffer(e),this.wrap=s,this.state="UNLOCKED",this.raw.ref.addEventListener("input",()=>this.keyPostRouter()),this.raw.ref.addEventListener("keydown",t=>this.keyPreRouter(t)),this.raw.ref.addEventListener("copy",t=>this.handleCopy(t)),this.raw.ref.addEventListener("keydown",t=>this.syncScrollbars(t)),this.raw.ref.addEventListener("paste",t=>this.handlePaste(t)),this.intervalUpdater=setInterval(()=>this.intervalUpdate(),1e3),this.focused=!0,document.addEventListener("visibilitychange",t=>this.focusToggle(t)),document.addEventListener("wheel",function(t){}),window.addEventListener("beforeunload",t=>this.safeShutdown(t)),this.setURL(r),this.keyPostRouter(),this.syncScrollbars(),this.handlePaste(),""!=r&&null!=r&&(document.title=this.exe.ref.textContent.split("\n")[0].substring(0,32))}debugDump(){console.log("=====STARTING=DEBUG=DUMP====="),console.log("Source Value:"),console.log(this.raw.ref.value.replaceAll("\n","\\n").replaceAll("	","\\t")),console.log("-----------------"),console.log("Display Value:"),console.log(this.exe.ref.innerHTML.replaceAll("\n","\\n").replaceAll("	","\\t")),console.log("=====END=DEBUG=DUMP=====")}safeShutdown(t){clearInterval(this.intervalUpdater),console.log("RTN Safe Shutdown Complete.")}focusToggle(t){this.focused=!this.focused,"hidden"===document.visibilityState?this.focused=!1:"visible"===document.visibilityState&&(this.focused=!0)}intervalUpdate(){this.focused&&this.keyPostRouter()}urlPreEncodeOnIdle(){let t=8192*Math.random()+0;this.shouldEncode=t,setTimeout(()=>this.urlPostEncodeOnIdle(t),1e3)}urlPostEncodeOnIdle(t){this.shouldEncode==t&&this.pushURL()}pullURL(){return this.uri.pull()}setURL(t){""!=t?this.raw.ref.value=t:this.raw.ref.value="Rapid Tree Notetaker\n	What is this?\n		The Rapid Tree Notetaker (RTN) is a notetaking tool developed by computer science student Brendan Rood at the University of Minnesota Duluth.\n		It aims to provide an easy way to take notes formatted similar to a Reddit thread, with indentation following a tree-like structure allowing for grouping.\n		It also prioritizes ease of sharing, as the URL can be shared to instantly communicate the note's contents.\n		It is free to use and will never ask you to log in.\n	Sample\n		Edit this text\n		to generate\n			a\n			document\n		formatted\n			like a tree!\n	Misc. Instructions\n		Indentation\n			Use TAB to indent\n			Supports block indentation editing\n		Limited Markdown Support\n			*You can wrap text with single asterisks to make it italic*\n			**You can wrap text with double asterisks to make it bold**\n			***You can wrap text in triple asterisks to make it both bold and italic***\n			`You can wrap text in backticks to mark it as computer code`\n			~~You can wrap text with double tildes to strike it though~~\n			[You can declare a link title](and a link address) to create a link\n				Normal links will also become clickable - EX: https://google.com"}pushURL(){var t=this.exe.ref.textContent.replace(/[\s]+$/,"");this.exe.tree.input=t,this.exe.tree.totalParse(),t=(t=(t=(t=(t=(t=this.exe.tree.output).replace(/├────── ​/gm,"├── ​")).replace(/└────── ​/gm,"└── ​")).replace(/│       ​/gm,"│   ​")).replace(/        ​/gm,"    ​")).replace(/<[^>]*>/g,""),console.log(t),this.uri.push(t),document.title=this.exe.ref.textContent.split("\n")[0].substring(0,32)}keyPreRouter(t){this.raw.keyHandler(t,t=>this.keyPostRouter(t)),this.urlPreEncodeOnIdle()}keyPostRouter(){this.raw.update(),this.exe.ref.innerHTML=this.raw.ref.value.replace(/\</g,"&lt;").replace(/\>/g,"&gt;"),this.exe.update(),this.syncScrollbars()}handlePaste(t){setTimeout(t=>this.syncScrollbars(t),100),setTimeout(()=>{this.raw.ref.value=this.raw.ref.value.replace(/├────── |│       |└────── |        /gm,"	"),this.raw.ref.value=this.raw.ref.value.replace(/├── |│   |└── |    /gm,"	")},100)}handleCopy(t){t.preventDefault(),this.keyPostRouter();var e=this.raw.ref.selectionStart,s=this.raw.ref.value.substring(0,e),r=u(s),i=this.raw.ref.selectionEnd,a=this.raw.ref.value.substring(e,i),n=u(a),l=this.raw.ref.selectionStart+8*r,o=this.raw.ref.selectionEnd+8*r+8*n,h=this.exe.ref.textContent.substring(l,o);function u(t){var e=t.match(/\t/gm);return null!=e?e.length:0}this.exe.tree.input=h,this.exe.tree.totalParse(),h=(h=(h=(h=(h=(h=this.exe.tree.output).replace(/├────── ​/gm,"├── ​")).replace(/└────── ​/gm,"└── ​")).replace(/│       ​/gm,"│   ​")).replace(/        ​/gm,"    ​")).replace(/\s$/,""),navigator.clipboard.writeText(h)}syncScrollbars(t){let e=document.getElementById("display"),s=document.getElementById("source"),r=document.getElementById("main"),i=document.getElementById("header");r.style.top=`${i.offsetHeight+10}px`;let a=`${e.offsetHeight+50}px`,n=`${e.offsetWidth+r.offsetLeft}px`;r.style.height=a,r.style.width=n,s.style.height=`${e.offsetHeight}px`,s.style.width=`${e.offsetWidth+r.offsetLeft}px`,r.style.minWidth=`${i.offsetWidth}px`,s.style.minWidth=`${i.offsetWidth}px`,e.style.minWidth=`${i.offsetWidth}px`}};class LevelNode{constructor(t,e){this.level=t,this.value=e}}class ProcessingTree{constructor(t){this.input=t,this.nodes=[],this.blocks=[],this.output=""}toNodes(){var t=this.input.split("\n");for(var e of t){var s=i(e);e=r(e),this.nodes.push(new LevelNode(s,e))}function r(t){var e=t;return e.replaceAll(/\t/g,"")}function i(t){var e=t.match(/^\t*(\t)/gm);return null!=e?e[0].length:0}}toBlocks(){for(var t of this.nodes){for(var e=[],s=0;s<t.level;s++)e.push(new a);""==t.value?e.push(new n):e.push(new i(t.value)),this.blocks.push(e)}}parseNewBlocks(){for(var i=this.blocks,a=0;a<i.length;a++)for(var n=0;n<i[a].length;n++){var l="";if(""==l&&"Data"==p(a,n,i)&&(l="Data"),""==l){var o=null;if("Data"==p(a,n+1,i)&&(("Null"==p(a+1,n,i)||"Data"==p(a+1,n,i))&&(o=!0),null==o)){var h=c(a,n,i),u=f(a,n,i);function c(t,e,s){for(var r=0;t<s.length&&!(t+1>s.length-1);){var i=p(t+1,e,s);if("Data"==i||"Null"==i)break;r++,t++}return r}function f(t,e,s){for(var r=0;t<s.length&&!(t+1>s.length-1);){var i=p(t+1,e+1,s);if("Data"==i||"Null"==i)break;r++,t++}return r}o=h<=u}o&&(i[a][n]=new s,l="Fork")}""==l&&"Data"==p(a,n+1,i)&&(i[a][n]=new e,l="Fork"),""==l&&("Gap"==p(a-1,n,i)||"Bend"==p(a-1,n,i))&&(i[a][n]=new r,l="Gap"),""==l&&("Line"==p(a-1,n,i)||"Fork"==p(a-1,n,i))&&(i[a][n]=new t,l="Line")}function p(t,e,s){return t<0||e<0||s.length-1<t||s[t].length-1<e?"Null":s[t][e].type}this.blocks=i}toString(){for(var t="",e=this.blocks,s=0;s<e.length;s++){for(var r=0;r<e[s].length;r++)t+=e[s][r].data;t+="\n"}this.output=t}totalParse(){this.nodes=[],this.blocks=[],this.output="",this.toNodes(),this.toBlocks(),this.parseNewBlocks(),this.toString()}}class VirtualBuffer{constructor(t){this.ref=t,this.start=t.selectionStart,this.end=t.selectionEnd,this.state="UNLOCKED"}writeCarrat(){this.ref.selectionStart=this.start,this.ref.selectionEnd=this.end}readCarrat(){this.start=this.ref.selectionStart,this.end=this.ref.selectionEnd}moveCarrat(t){this.start+=t,this.end+=t,this.writeCarrat()}countCaretLeft(){var t=this.ref.value.substring(0,this.start).split("\n");return t[t.length-1].split("	").length-1}keyHandler(t,e){if(void 0==t&&(t={key:"none"}),"LOCKED"==this.state){setTimeout(()=>{this.keyHandler(t,e)},10);return}if(this.readCarrat(),"Tab"==t.key){if(t.preventDefault(),this.start==this.end)u(this.ref.value,this.start)&&(this.ref.value=this.ref.value.substring(0,this.start)+"	"+this.ref.value.substring(this.end),this.moveCarrat(1));else{for(var s=this.start,r=this.end-1;"\n"!=this.ref.value.substring(s,s+1)&&s>0;)s--;for(;"\n"!=this.ref.value.substring(r,r+1)&&r>0;)r--;var i=[],a=s;for(i.push(s);a<r-1;)a++,"\n"==this.ref.value.substring(a,a+1)&&i.push(a);r!=s&&i.push(r);var n=1;for(var l of i)u(this.ref.value,l+n)&&(t.shiftKey?"	"==this.ref.value.substring(l+n,l+n+1)&&(this.ref.value=this.ref.value.substring(0,l+n)+""+this.ref.value.substring(l+n+1),n++,this.ref.selectionStart=l+n,this.ref.selectionEnd=l+n):(this.ref.value=this.ref.value.substring(0,l+n)+"	"+this.ref.value.substring(l+n),n++,this.ref.selectionStart=l+n,this.ref.selectionEnd=l+n))}}if("Enter"==t.key&&(t.preventDefault(),function t(e,s){var r=e.substring(0,s).split("\n"),i=l(r[r.length-1])>0,a=e.split("\n")[r.length];null==a&&(a="PROCEED");var n=l(a)>0;return!0==i&&!0==n;function l(t){var e=t.match(/\S/gm);return null!=e?e.length:0}}(this.ref.value,this.start))){var o=this.countCaretLeft();this.ref.value=this.ref.value.substring(0,this.start)+"\n"+this.ref.value.substring(this.end),this.moveCarrat(1);for(var h=0;h<o;h++)this.ref.value=this.ref.value.substring(0,this.start)+"	"+this.ref.value.substring(this.end),this.moveCarrat(1)}function u(t,e){var s=(t=t.substring(0,e)).split("\n"),r=s[s.length-1],i="";s.length>1&&(i=s[s.length-2]);var a=t.substring(e-1,e),n=l(r)<=l(i);return("	"==a||"\n"==a)&&n;function l(t){var e=t.match(/^\t*(\t)/gm);return null!=e?e[0].length:0}}this.state="LOCKED",setTimeout(()=>{e()},10)}update(){this.state="UNLOCKED",this.readCarrat()}}class RawBuffer extends VirtualBuffer{constructor(t){super(t)}update(){this.ref.value=this.ref.value.replace(/[└├│─ ]*​/gm,"	"),this.ref.value=this.ref.value.replace(/(?:\t+[\S ]+)(\t+)/gm,"	"),super.update()}}class ExeBuffer extends VirtualBuffer{constructor(t){super(t),this.tree=new ProcessingTree("")}update(){this.tree.input=this.ref.textContent,this.tree.totalParse();var t=this.tree.output;t=(t=(t=(t=(t=(t=(t=(t=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")).replace(/(\[(.+?)\]\((.+?)\))|(https?:\/\/\S+)/g,function(t,e,s,r,i){return r?`<a style="z-index: 4; pointer-events: all; position: relative;" href="${r}"><b>[${s}](${r})</b></a>`:`<a style="z-index: 4; pointer-events: all; position: relative;" href="${i}"><b>${i}</b></a>`})).replace(/(?<!\*)(\*{1})([^\n*]+?)(\1)(?!\*)/g,'<span style="color:cyan"><b>$1</b></span><i>$2</i><span style="color:cyan"><b>$3</b></span>')).replace(/(?<!\*)(\*{2})([^\n*]+?)(\1)(?!\*)/g,'<span style="color:cyan"><b>$1</b></span><b>$2</b><span style="color:cyan"><b>$3</b></span>')).replace(/(?<!\*)(\*{3})([^\n*]+?)(\1)(?!\*)/g,'<span style="color:cyan"><b>$1</b></span><i><b>$2</b></i><span style="color:cyan"><b>$3</b></span>')).replace(/(?<!\~)(\~{2})([^\n~]+?)(\1)(?!\~)/g,'<span style="color:cyan"><b>$1</b></span><del>$2</del><span style="color:cyan"><b>$3</b></span>')).replace(/(?<!\`)(\`{1})([^\n`]+?)(\1)(?!\`)/g,'<span style="color: rgb(232,145,45); background-color: rgb(44, 46, 54);"><b>$1</b>$2<b>$3</b></span>')).replace(/[└├│─ ]*​/gm,function(t){return`<span style="color: cyan;">${t}</span>`}),this.ref.innerHTML=t,super.update()}}