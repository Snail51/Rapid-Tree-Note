/**
Copyright 2023, Brendan Andrew Rood
*/

/**
This file is part of the Rapid-Tree-Note / RTN program.

RTN is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

RTN is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License along with RTN. It is avalible at ./License/COPYING. Otherwise, see <https://www.gnu.org/licenses/>
*/

import{Line as t,Fork as e,Bend as r,Gap as s,Data as i,New as a,End as n,Null as l}from"./treeblocks.js";import{URIMannager as o}from"./URI-mannager.js";export default class h{constructor(t,e,r){this.maxURLLength=8192,this.uri=new o,window.main=this;var s=this.pullURL();this.raw=new RawBuffer(t),this.exe=new ExeBuffer(e),this.wrap=r,this.state="UNLOCKED",this.raw.ref.addEventListener("input",()=>this.keyPostRouter()),this.raw.ref.addEventListener("keydown",t=>this.keyPreRouter(t)),this.raw.ref.addEventListener("copy",t=>this.handleCopy(t)),this.raw.ref.addEventListener("keydown",t=>this.syncScrollbars(t)),this.raw.ref.addEventListener("paste",t=>this.handlePaste(t)),this.intervalUpdater=setInterval(()=>this.intervalUpdate(),1e3),this.focused=!0,document.addEventListener("visibilitychange",t=>this.focusToggle(t)),document.addEventListener("wheel",function(t){}),window.addEventListener("beforeunload",t=>this.safeShutdown(t)),this.setURL(s),this.keyPostRouter(),this.syncScrollbars(),this.handlePaste(),""!=s&&null!=s&&(document.title=this.exe.ref.textContent.split("\n")[0].substring(0,32))}debugDump(){console.debug("=====STARTING=DEBUG=DUMP====="),console.debug("Source Value:"),console.debug(this.raw.ref.value.replaceAll("\n","\\n").replaceAll("	","\\t")),console.debug("-----------------"),console.debug("Display Value:"),console.debug(this.exe.ref.innerHTML.replaceAll("\n","\\n").replaceAll("	","\\t")),console.debug("=====END=DEBUG=DUMP=====")}safeShutdown(t){clearInterval(this.intervalUpdater),console.debug("RTN Safe Shutdown Complete.")}focusToggle(t){this.focused=!this.focused,"hidden"===document.visibilityState?this.focused=!1:"visible"===document.visibilityState&&(this.focused=!0)}intervalUpdate(){this.focused&&this.keyPostRouter()}urlPreEncodeOnIdle(){let t=8192*Math.random()+0;this.shouldEncode=t,setTimeout(()=>this.urlPostEncodeOnIdle(t),1e3)}urlPostEncodeOnIdle(t){this.shouldEncode==t&&this.pushURL()}pullURL(){return this.uri.pull()}setURL(t){""!=t?this.raw.ref.value=t:this.raw.ref.value="Rapid Tree Notetaker\n	What is this?\n		The Rapid Tree Notetaker (RTN) is a notetaking tool developed by computer science student Brendan Rood at the University of Minnesota Duluth.\n		It aims to provide an easy way to take notes formatted similar to a Reddit thread, with indentation following a tree-like structure allowing for grouping.\n		It also prioritizes ease of sharing, as the URL can be shared to instantly communicate the note's contents.\n		It is free to use and will never ask you to log in.\n	Sample\n		Edit this text\n		to generate\n			a\n			document\n		formatted\n			like a tree!\n			:3\n	Misc. Instructions\n		Indentation\n			Use TAB to indent\n			Supports block indentation editing\n		Limited Markdown Support\n			*You can wrap text with single asterisks to make it italic*\n			**You can wrap text with double asterisks to make it bold**\n			***You can wrap text in triple asterisks to make it both bold and italic***\n			`You can wrap text in backticks to mark it as computer code`\n			~~You can wrap text with double tildes to strike it though~~\n			• Starting a line with a dash or a single asterisk will turn it into a bullet point\n			[You can declare a link title](and a link address) to create a link\n				Normal links will also become clickable - EX: https://google.com\n		Directory-Style Document Navigation Links\n			The RTN allows you to link to other locations in the same document via a directory-style link\n			For Example, ./../../../[Samp]/[2]/[1] will bring you to the smiley face in this document\n			Note that DirNav links always start with `./` , followed by N navigational tokens\n				.. - Navigate to the PARENT\n				[0-9] - Navigate to the CHILD at the provided Index. (Uses 0-Index Base)\n				[.*] - Navigate to the CHILD who's value starts with the provided string\n			Invalid links will have no apparent effect. Check the console (verbose) to learn more."}pushURL(){var t=this.exe.ref.textContent.replace(/[\s]+$/,"");this.exe.tree.input=t,this.exe.tree.totalParse(),t=(t=(t=(t=(t=(t=this.exe.tree.output).replace(/├────── ​/gm,"├── ​")).replace(/└────── ​/gm,"└── ​")).replace(/│       ​/gm,"│   ​")).replace(/        ​/gm,"    ​")).replace(/<[^>]*>/g,""),console.debug(t),this.uri.push(t),document.title=this.exe.ref.textContent.split("\n")[0].substring(0,32)}keyPreRouter(t){this.raw.keyHandler(t,t=>this.keyPostRouter(t)),this.urlPreEncodeOnIdle()}keyPostRouter(){this.raw.update(),this.exe.ref.innerHTML=this.raw.ref.value.replace(/\</g,"&lt;").replace(/\>/g,"&gt;"),this.exe.update(),this.syncScrollbars()}handlePaste(t){setTimeout(t=>this.syncScrollbars(t),100),setTimeout(()=>{this.raw.ref.value=this.raw.ref.value.replace(/├────── |│       |└────── |        /gm,"	"),this.raw.ref.value=this.raw.ref.value.replace(/├── |│   |└── |    /gm,"	")},100)}handleCopy(t){t.preventDefault(),this.keyPostRouter();var e=this.raw.ref.selectionStart,r=this.raw.ref.value.substring(0,e),s=u(r),i=this.raw.ref.selectionEnd,a=this.raw.ref.value.substring(e,i),n=u(a),l=this.raw.ref.selectionStart+8*s,o=this.raw.ref.selectionEnd+8*s+8*n,h=this.exe.ref.textContent.substring(l,o);function u(t){var e=t.match(/\t/gm);return null!=e?e.length:0}this.exe.tree.input=h,this.exe.tree.totalParse(),h=(h=(h=(h=(h=(h=this.exe.tree.output).replace(/├────── ​/gm,"├── ​")).replace(/└────── ​/gm,"└── ​")).replace(/│       ​/gm,"│   ​")).replace(/        ​/gm,"    ​")).replace(/\s$/,""),navigator.clipboard.writeText(h)}syncScrollbars(t){let e=document.getElementById("display"),r=document.getElementById("source"),s=document.getElementById("main"),i=document.getElementById("header");s.style.top=`${i.offsetHeight+10}px`;let a=`${e.offsetHeight+50}px`,n=`${e.offsetWidth+s.offsetLeft}px`;s.style.height=a,s.style.width=n,r.style.height=`${e.offsetHeight}px`,r.style.width=`${e.offsetWidth+s.offsetLeft}px`,s.style.minWidth=`${i.offsetWidth}px`,r.style.minWidth=`${i.offsetWidth}px`,e.style.minWidth=`${i.offsetWidth}px`}hardFix(){this.raw.update(),this.exe.ref.tree.input=this.raw.ref.value,this.exe.tree.totalParse(),this.exe.update();var t=this.raw.ref.selectionStart,e=this.raw.ref.selectionEnd;this.raw.ref.value=this.exe.tree.content.substring(0,this.exe.tree.content.length-1),this.raw.update(),this.exe.ref.textContent=this.raw.ref.value,this.exe.tree.totalParse(),this.exe.update(),this.raw.ref.selectionStart=t,this.raw.ref.selectionEnd=e}dirnav(t,e,r){t.preventDefault();var s,i,a=this.raw.ref.value.split("\n"),n=a.length-1,l=r,o=e.split("/").filter(t=>null!=t&&""!==t&&"."!==t),h={Payload:e,Index:r,Lines:a,LowerBound:0,UpperBound:n,Actions:o};for(console.debug(h.Actions);0!=o.length;){if(".."==o[0]){var u=$(a[l])-1;if(u<0){console.error("DirNav called for invalid Indent Level "+u,h);return}for(;l>=0&&$(a[l])!=u;)l--;if(l<0){console.error("DirNav could not find a proper parent...",h);return}o.shift()}else{var d=$(a[l]);if(o[0].match(/\[[0-9]*\]/)){for(var c=parseInt(o[0].substring(1,o[0].length-1),10),f=-1;f<c&&l<=n;){if($(a[++l])<=d){console.error("DirNav failed to find a child of index ["+c+"] before exhausting the domain!",h);return}$(a[l])==d+1&&f++}o.shift()}else{let p=RegExp("^\\s*"+o[0].substring(1,o[0].length-1).replace(/(.)/g,"\\$1")+".*");for(;!a[l].match(p)&&l<=n;)if($(a[++l])<=d){console.error("DirNav failed to find a child of key ["+o[0].substring(1,o[0].length-1)+"] before exhausting the domain!",h);return}o.shift()}}console.debug("an action was consumed... current linePointer="+l)}for(var g="",v=0;v<l;v++)g+=a[v]+"\n";var b=(g=g.substring(0,g.length-1)).length,w=a[l].match(/^(\s*)([^\n]*)/),y=w[1].length,m=w[2].length;function $(t){return t.split("	").length-1}this.raw.start=b+y,this.raw.end=b+y+m,0!=this.raw.start&&(this.raw.start++,this.raw.end++),this.raw.ref.focus(),this.raw.writeCarrat(),s=this.raw.ref,(i=document.createElement("div")).style.position="absolute",i.style.color="red",i.style.padding="5px",i.style.wordBreak="normal",i.style.whiteSpace="pre-wrap",i.style.border="solid 4px transparent",i.style.fontSize=document.getElementById("source").style.fontSize,document.getElementById("main").appendChild(i),i.innerHTML=s.value.substring(0,s.selectionEnd)+'<span id="dirNavCarrat"></span>',document.getElementById("dirNavCarrat").scrollIntoView(),window.scrollBy(0,-1*document.getElementById("header").offsetHeight-24),document.getElementById("dirNavCarrat").remove(),document.getElementById("main").removeChild(i)}};class LevelNode{constructor(t,e){this.level=t,this.value=e}}class ProcessingTree{constructor(t){this.input=t,this.nodes=[],this.blocks=[],this.output=""}toNodes(){var t=this.input.split("\n");for(var e of t){var r=i(e);e=s(e),this.nodes.push(new LevelNode(r,e))}function s(t){var e=t;return e.replaceAll(/\t/g,"")}function i(t){var e=t.match(/^\t*(\t)/gm);return null!=e?e[0].length:0}}toBlocks(){for(var t of this.nodes){for(var e=[],r=0;r<t.level;r++)e.push(new a);""==t.value?e.push(new n):e.push(new i(t.value)),this.blocks.push(e)}}parseNewBlocks(){for(var i=this.blocks,a=0;a<i.length;a++)for(var n=0;n<i[a].length;n++){var l="";if(""==l&&"Data"==f(a,n,i)&&(l="Data"),""==l){var o=null;if("Data"==f(a,n+1,i)&&(("Null"==f(a+1,n,i)||"Data"==f(a+1,n,i))&&(o=!0),null==o)){var h=d(a,n,i),u=c(a,n,i);function d(t,e,r){for(var s=0;t<r.length&&!(t+1>r.length-1);){var i=f(t+1,e,r);if("Data"==i||"Null"==i)break;s++,t++}return s}function c(t,e,r){for(var s=0;t<r.length&&!(t+1>r.length-1);){var i=f(t+1,e+1,r);if("Data"==i||"Null"==i)break;s++,t++}return s}o=h<=u}o&&(i[a][n]=new r,l="Fork")}""==l&&"Data"==f(a,n+1,i)&&(i[a][n]=new e,l="Fork"),""==l&&("Gap"==f(a-1,n,i)||"Bend"==f(a-1,n,i))&&(i[a][n]=new s,l="Gap"),""==l&&("Line"==f(a-1,n,i)||"Fork"==f(a-1,n,i))&&(i[a][n]=new t,l="Line")}function f(t,e,r){return t<0||e<0||r.length-1<t||r[t].length-1<e?"Null":r[t][e].type}this.blocks=i}toString(){for(var t="",e=this.blocks,r=0;r<e.length;r++){for(var s=0;s<e[r].length;s++)t+=e[r][s].data;t+="\n"}this.output=t}totalParse(){this.nodes=[],this.blocks=[],this.output="",this.toNodes(),this.toBlocks(),this.parseNewBlocks(),this.toString()}}class VirtualBuffer{constructor(t){this.ref=t,this.start=t.selectionStart,this.end=t.selectionEnd,this.state="UNLOCKED"}writeCarrat(){this.ref.selectionStart=this.start,this.ref.selectionEnd=this.end}readCarrat(){this.start=this.ref.selectionStart,this.end=this.ref.selectionEnd}moveCarrat(t){this.start+=t,this.end+=t,this.writeCarrat()}countCaretLeft(){var t=this.ref.value.substring(0,this.start).split("\n");return t[t.length-1].split("	").length-1}keyHandler(t,e){if(void 0==t&&(t={key:"none"}),"LOCKED"==this.state){setTimeout(()=>{this.keyHandler(t,e)},10);return}if(this.readCarrat(),"Tab"==t.key){if(t.preventDefault(),this.start==this.end)u(this.ref.value,this.start)&&(this.ref.value=this.ref.value.substring(0,this.start)+"	"+this.ref.value.substring(this.end),this.moveCarrat(1));else{for(var r=this.start,s=this.end-1;"\n"!=this.ref.value.substring(r,r+1)&&r>0;)r--;for(;"\n"!=this.ref.value.substring(s,s+1)&&s>0;)s--;var i=[],a=r;for(i.push(r);a<s-1;)a++,"\n"==this.ref.value.substring(a,a+1)&&i.push(a);s!=r&&i.push(s);var n=1;for(var l of i)u(this.ref.value,l+n)&&(t.shiftKey?"	"==this.ref.value.substring(l+n,l+n+1)&&(this.ref.value=this.ref.value.substring(0,l+n)+""+this.ref.value.substring(l+n+1),n++,this.ref.selectionStart=l+n,this.ref.selectionEnd=l+n):(this.ref.value=this.ref.value.substring(0,l+n)+"	"+this.ref.value.substring(l+n),n++,this.ref.selectionStart=l+n,this.ref.selectionEnd=l+n))}}if("Enter"==t.key&&(t.preventDefault(),function t(e,r){var s=e.substring(0,r).split("\n"),i=l(s[s.length-1])>0,a=e.split("\n")[s.length];null==a&&(a="PROCEED");var n=l(a)>0;return!0==i&&!0==n;function l(t){var e=t.match(/\S/gm);return null!=e?e.length:0}}(this.ref.value,this.start))){var o=this.countCaretLeft();this.ref.value=this.ref.value.substring(0,this.start)+"\n"+this.ref.value.substring(this.end),this.moveCarrat(1);for(var h=0;h<o;h++)this.ref.value=this.ref.value.substring(0,this.start)+"	"+this.ref.value.substring(this.end),this.moveCarrat(1)}function u(t,e){var r=(t=t.substring(0,e)).split("\n"),s=r[r.length-1],i="";r.length>1&&(i=r[r.length-2]);var a=t.substring(e-1,e),n=l(s)<=l(i);return("	"==a||"\n"==a)&&n;function l(t){var e=t.match(/^\t*(\t)/gm);return null!=e?e[0].length:0}}this.state="LOCKED",setTimeout(()=>{e()},10)}update(){this.state="UNLOCKED",this.readCarrat()}}class RawBuffer extends VirtualBuffer{constructor(t){super(t)}update(){this.ref.value=this.ref.value.replace(/[└├│─ ]*​/gm,"	"),this.ref.value=this.ref.value.replace(/(?:\t+[\S ]+)(\t+)/gm,"	"),super.update()}}class ExeBuffer extends VirtualBuffer{constructor(t){super(t),this.tree=new ProcessingTree("")}update(){this.tree.input=this.ref.textContent,this.tree.totalParse();for(var t=this.tree.output,e=(t=(t=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")).replace(/(\[(.+?)\]\((.+?)\))|(https?:\/\/\S+)/g,function(t,e,r,s,i){return s?`<a style="z-index: 4; pointer-events: all; position: relative;" href="${s}"><b>[${r}](${s})</b></a>`:`<a style="z-index: 4; pointer-events: all; position: relative;" href="${i}"><b>${i}</b></a>`})).split("\n"),r=0;r<e.length;r++)e[r]=e[r].replace(/(\.(?:\/\.\.|\/\[[^\]]+\])+\/?)/g,'<a style="z-index: 4; pointer-events: all; position: relative; color: rgb(82,235,0);" href="#" onclick="window.main.dirnav(event, \'$1\', '+r+');"><b>$1</b></a>');var s="";for(var i of e)s+=i+"\n";t=(t=(t=(t=(t=(t=(t=(t=(t=s=s.substring(0,s.length-1)).replace(/(?<!\*)(\*{1})([^\n*]+?)(\1)(?!\*)/g,'<span style="color:cyan"><b>$1</b></span><i>$2</i><span style="color:cyan"><b>$3</b></span>')).replace(/^((?:[└├│─ ]*​)*)(-)( )/gm,"$1•$3")).replace(/^((?:[└├│─ ]*​)*)(\*)( )(?!.*\*)/gm,"$1•$3")).replace(/(?<!\*)(\*{2})([^\n*]+?)(\1)(?!\*)/g,'<span style="color:cyan"><b>$1</b></span><b>$2</b><span style="color:cyan"><b>$3</b></span>')).replace(/(?<!\*)(\*{3})([^\n*]+?)(\1)(?!\*)/g,'<span style="color:cyan"><b>$1</b></span><i><b>$2</b></i><span style="color:cyan"><b>$3</b></span>')).replace(/(?<!\~)(\~{2})([^\n~]+?)(\1)(?!\~)/g,'<span style="color:cyan"><b>$1</b></span><del>$2</del><span style="color:cyan"><b>$3</b></span>')).replace(/(?<!\`)(\`{1})([^\n`]+?)(\1)(?!\`)/g,'<span style="color: rgb(232,145,45); background-color: rgb(44, 46, 54);"><b>$1</b>$2<b>$3</b></span>')).replace(/[└├│─ ]*​/gm,function(t){return`<span style="color: cyan;">${t}</span>`}),this.ref.innerHTML=t,super.update()}}