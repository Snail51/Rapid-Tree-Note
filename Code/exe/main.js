/**
Copyright 2023, Brendan Andrew Rood
*/

/**
This file is part of the Rapid-Tree-Note / RTN program.

RTN is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

RTN is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License along with Foobar. It is avalible at ./License/COPYING. Otherwise, see <https://www.gnu.org/licenses/>
*/

import{Line as t,Fork as e,Bend as r,Gap as s,Data as a,New as i,End as n,Null as l}from"./treeblocks.js";export default class h{constructor(t,e){var r=this.pullURL();this.raw=new RawBuffer(t),this.exe=new ExeBuffer(e),this.state="UNLOCKED",this.raw.ref.addEventListener("input",()=>this.keyPostRouter()),this.raw.ref.addEventListener("keydown",t=>this.keyPreRouter(t)),this.raw.ref.addEventListener("copy",t=>this.handleCopy(t)),this.raw.ref.addEventListener("scroll",t=>this.syncScrollbars(t)),this.raw.ref.addEventListener("paste",t=>this.handlePaste(t)),this.focused=!0,document.addEventListener("visibilitychange",t=>this.focusToggle(t)),window.addEventListener("beforeunload",t=>this.safeShutdown(t)),this.setURL(r),this.keyPostRouter(),this.syncScrollbars(),this.handlePaste(),this.maxURLLength=8192}safeShutdown(t){clearInterval(this.intervalUpdater),console.log("RTN Safe Shutdown Complete.")}focusToggle(t){this.focused=!this.focused,"hidden"===document.visibilityState?this.focused=!1:"visible"===document.visibilityState&&(this.focused=!0)}intervalUpdate(){this.focused&&(this.keyPostRouter(),this.syncScrollbars())}urlPreEncodeOnIdle(){let t=8192*Math.random()+0;this.shouldEncode=t,setTimeout(()=>this.urlPostEncodeOnIdle(t),1e3)}urlPostEncodeOnIdle(t){this.shouldEncode==t&&this.pushURL()}pullURL(){var t=/(?:data=)(.*)/gm.exec(window.location.href);if(null==t||""==t[1])t="";else{t=(t=function t(e){let r=e.replace(/-/g,"+").replace(/_/g,"/"),s=Array.from(atob(r),t=>t.charCodeAt(0)),a=s.map(t=>t.toString(16).padStart(2,"0")).join("");return a}(t=decodeURIComponent(t=t[1]))).match(/.{2}/g);var e=[];for(var r of t)e.push(parseInt(r,16));t=new Uint8Array(e);try{t=pako.inflate(t,{to:"string"})}catch(s){t="There was a problem decoding the data in the link.\nAre you sure it was produced by this program?\nError has been printed to console.",console.error(s)}}return t}setURL(t){""!=t?this.raw.ref.value=t:this.raw.ref.value="Edit this text\n	to generate\n		a\n		document\n	formatted\n		like a tree!\n			:3\n	Use TABS to indent, NOT SPACES!"}pushURL(){var t=this.exe.ref.value.substring(0,this.exe.ref.value.length-1);t=pako.deflate(t,{level:9,to:"string"});var e="";for(var r of t)e+=r.toString(16).padStart(2,"0").toUpperCase();(t=encodeURIComponent(t=function t(e){let r=e.match(/.{1,2}/g).map(t=>parseInt(t,16)),s=btoa(String.fromCharCode(...r)),a=s.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");return a}(e))).length+512>this.maxURLLength&&(t="MAXIMUM-LINK-LENGTH-EXCEEDED"),history.replaceState({},"","https://lars.d.umn.edu/RTN/program.html?data="+t)}keyPreRouter(t){this.raw.keyHandler(t,t=>this.keyPostRouter(t)),this.urlPreEncodeOnIdle()}keyPostRouter(){this.raw.update(),this.exe.ref.value=this.raw.ref.value,this.exe.tree.totalParse(),this.exe.update()}handlePaste(t){setTimeout(t=>this.syncScrollbars(t),100),setTimeout(()=>{this.raw.ref.value=this.raw.ref.value.replace(/├────── |│       |└────── |        /gm,"	"),this.raw.ref.value=this.raw.ref.value.replace(/├── |│   |└── |    /gm,"	")},100)}handleCopy(t){t.preventDefault(),this.keyPostRouter();var e=this.raw.ref.selectionStart,r=this.raw.ref.value.substring(0,e),s=u(r),a=this.raw.ref.selectionEnd,i=this.raw.ref.value.substring(e,a),n=u(i),l=this.raw.ref.selectionStart+8*s,h=this.raw.ref.selectionEnd+8*s+8*n,o=this.exe.ref.value.substring(l,h);function u(t){var e=t.match(/\t/gm);return null!=e?e.length:0}o=(o=(o=(o=o.replace(/├────── ​/gm,"├── ​")).replace(/└────── ​/gm,"└── ​")).replace(/│       ​/gm,"│   ​")).replace(/        ​/gm,"    ​"),navigator.clipboard.writeText(o)}syncScrollbars(t){this.exe.ref.scrollTop=this.raw.ref.scrollTop}};class LevelNode{constructor(t,e){this.level=t,this.value=e}}class ProcessingTree{constructor(t){this.input=t,this.nodes=[],this.blocks=[],this.output=""}toNodes(){var t=this.input.split("\n");for(var e of t){var r=a(e);e=s(e),this.nodes.push(new LevelNode(r,e))}function s(t){var e=t;return e.replaceAll(/\t/g,"")}function a(t){var e=t.match(/^\t*(\t)/gm);return null!=e?e[0].length:0}}toBlocks(){for(var t of this.nodes){for(var e=[],r=0;r<t.level;r++)e.push(new i);""==t.value?e.push(new n):e.push(new a(t.value)),this.blocks.push(e)}}parseNewBlocks(){for(var a=this.blocks,i=0;i<a.length;i++)for(var n=0;n<a[i].length;n++){var l="";if(""==l&&"Data"==d(i,n,a)&&(l="Data"),""==l){var h=null;if("Data"==d(i,n+1,a)&&(("Null"==d(i+1,n,a)||"Data"==d(i+1,n,a))&&(h=!0),null==h)){var o=f(i,n,a),u=c(i,n,a);function f(t,e,r){for(var s=0;t<r.length&&!(t+1>r.length-1);){var a=d(t+1,e,r);if("Data"==a||"Null"==a)break;s++,t++}return s}function c(t,e,r){for(var s=0;t<r.length&&!(t+1>r.length-1);){var a=d(t+1,e+1,r);if("Data"==a||"Null"==a)break;s++,t++}return s}h=o<=u}h&&(a[i][n]=new r,l="Fork")}""==l&&"Data"==d(i,n+1,a)&&(a[i][n]=new e,l="Fork"),""==l&&("Gap"==d(i-1,n,a)||"Bend"==d(i-1,n,a))&&(a[i][n]=new s,l="Gap"),""==l&&("Line"==d(i-1,n,a)||"Fork"==d(i-1,n,a))&&(a[i][n]=new t,l="Line")}function d(t,e,r){return t<0||e<0||r.length-1<t||r[t].length-1<e?"Null":r[t][e].type}this.blocks=a}toString(){for(var t="",e=this.blocks,r=0;r<e.length;r++){for(var s=0;s<e[r].length;s++)t+=e[r][s].data;t+="\n"}this.output=t}totalParse(){this.nodes=[],this.blocks=[],this.output="",this.toNodes(),this.toBlocks(),this.parseNewBlocks(),this.toString()}}class VirtualBuffer{constructor(t){this.ref=t,this.start=t.selectionStart,this.end=t.selectionEnd,this.state="UNLOCKED"}writeCarrat(){this.ref.selectionStart=this.start,this.ref.selectionEnd=this.end}readCarrat(){this.start=this.ref.selectionStart,this.end=this.ref.selectionEnd}moveCarrat(t){this.start+=t,this.end+=t,this.writeCarrat()}countCaretLeft(){var t=this.ref.value.substring(0,this.start).split("\n");return t[t.length-1].split("	").length-1}keyHandler(t,e){if("LOCKED"==this.state){setTimeout(()=>{this.keyHandler(t,e)},10);return}if(this.readCarrat(),"Tab"==t.key&&(t.preventDefault(),function t(e,r){var s=(e=e.substring(0,r)).split("\n"),a=s[s.length-1],i="";s.length>1&&(i=s[s.length-2]);var n=e.substring(r-1,r),l=h(a)<=h(i);return("	"==n||"\n"==n)&&l;function h(t){var e=t.match(/^\t*(\t)/gm);return null!=e?e[0].length:0}}(this.ref.value,this.start)&&(this.ref.value=this.ref.value.substring(0,this.start)+"	"+this.ref.value.substring(this.end),this.moveCarrat(1))),"Enter"==t.key&&(t.preventDefault(),function t(e,r){var s=e.substring(0,r).split("\n"),a=l(s[s.length-1])>0,i=e.split("\n")[s.length];null==i&&(i="PROCEED");var n=l(i)>0;return!0==a&&!0==n;function l(t){var e=t.match(/\S/gm);return null!=e?e.length:0}}(this.ref.value,this.start))){var r=this.countCaretLeft();this.ref.value=this.ref.value.substring(0,this.start)+"\n"+this.ref.value.substring(this.end),this.moveCarrat(1);for(var s=0;s<r;s++)this.ref.value=this.ref.value.substring(0,this.start)+"	"+this.ref.value.substring(this.end),this.moveCarrat(1)}this.state="LOCKED",setTimeout(()=>{e()},10)}update(){this.state="UNLOCKED",this.readCarrat()}}class RawBuffer extends VirtualBuffer{constructor(t){super(t)}update(){this.ref.value=this.ref.value.replace(/[└├│─ ]*​/gm,"	"),this.ref.value=this.ref.value.replace(/(?:\t+[\S ]+)(\t+)/gm,"	"),super.update()}}class ExeBuffer extends VirtualBuffer{constructor(t){super(t),this.tree=new ProcessingTree("")}update(){this.tree.input=this.ref.value,this.tree.totalParse(),this.ref.value=this.tree.output,super.update()}}