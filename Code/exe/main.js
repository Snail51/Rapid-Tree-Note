/**
Copyright 2023-2025, Brendan Andrew Rood
*/

/**
This file is part of the Rapid-Tree-Note / RTN program.

RTN is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

RTN is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License along with RTN. It is available at ./License/COPYING. Otherwise, see <https://www.gnu.org/licenses/#AGPL>
*/

// MINIFIED VERSION OF THE FILE OF THE SAME NAME IN THE `src` FOLDER
// MINIFIED WITH https://www.toptal.com/developers/javascript-minifier
// MINIFIED AT Sun Apr 20 15:06:23 CDT 2025

import{RawBuffer as e,ExeBuffer as t}from"./buffers.js";import{URIManager as r}from"./URI-manager.js";import{Provider as i}from"./provider.js";import{Formatter as s}from"./format.js";export class Schema{constructor(s,a,n){this.maxURLLength=8192,this.uri=new r,window.main=this,this.provider=new i("file_save");var l=this.pullURL();this.raw=new e(s),this.exe=new t(a),this.wrap=n,this.state="UNLOCKED",this.raw.ref.addEventListener("keydown",e=>this.keyPreRouter(e)),this.raw.ref.addEventListener("input",()=>this.keyPostRouter()),this.raw.ref.addEventListener("copy",e=>this.handleCopy(e)),this.raw.ref.addEventListener("click",e=>this.urlPreEncodeOnIdle(e)),this.raw.ref.addEventListener("input",()=>this.urlPreEncodeOnIdle()),this.raw.ref.addEventListener("paste",e=>this.handlePaste(e)),this.raw.ref.addEventListener("keydown",e=>this.syncScrollbars(e)),this.raw.ref.addEventListener("click",e=>this.syncScrollbars(e)),document.addEventListener("wheel",e=>this.scaleTextOnZoom(e),{passive:!1}),this.intervalUpdater=setInterval(()=>this.intervalUpdate(),1e3),this.focused=!0,document.addEventListener("visibilitychange",e=>this.focusToggle(e)),window.addEventListener("beforeunload",e=>this.safeShutdown(e)),this.setURL(l),this.keyPostRouter(),this.syncScrollbars(),this.handlePaste(),this.urlPreEncodeOnIdle(),""!=l&&null!=l&&(document.title=this.exe.ref.textContent.split("\n")[0].substring(0,32))}debugDump(){console.debug("=====STARTING=DEBUG=DUMP====="),console.debug("Source Value:"),console.debug(s.escapeWhitespace(this.raw.ref.value)),console.debug("-----------------"),console.debug("Display Value:"),console.debug(s.escapeWhitespace(this.exe.ref.innerHTML)),console.debug("=====END=DEBUG=DUMP=====")}safeShutdown(e){clearInterval(this.intervalUpdater),console.debug("RTN Safe Shutdown Complete.")}focusToggle(e){this.focused=!this.focused,"hidden"===document.visibilityState?this.focused=!1:"visible"===document.visibilityState&&(this.focused=!0)}scaleTextOnZoom(e){if(!e.ctrlKey)return;e.preventDefault();let t=parseFloat(document.getElementById("display").style.fontSize),r=parseFloat(document.getElementById("display").style.top),i=parseFloat(document.getElementById("source").style.fontSize);e.deltaY>0&&(t=Math.max(.5,t-.1),i=Math.max(.5,i-.1)),e.deltaY<0&&(t=Math.min(2,t+.1),i=Math.min(2,i+.1)),r=-1*t,document.getElementById("display").style.fontSize=t+"vw",document.getElementById("source").style.fontSize=i+"vw",document.getElementById("display").style.top=r+"vw"}intervalUpdate(){this.focused&&this.keyPostRouter()}darkenBorder(){var e=document.getElementById("display").style.border;if(""!=e){var t=parseInt(e.substring(17,20));if(0==t){clearInterval(this.outlineInterval);return}t=Math.max(t-5,0),document.getElementById("display").style.border=`0.25vw solid rgb(${t},${t},${t})`}}urlPreEncodeOnIdle(){let e=8192*Math.random()+0;this.shouldEncode=e,setTimeout(()=>this.urlPostEncodeOnIdle(e),1e3)}urlPostEncodeOnIdle(e){if(this.shouldEncode==e){this.pushURL(),document.getElementById("display").style.border="0.25vw solid rgb(255,255,255)",this.outlineInterval=setInterval(()=>this.darkenBorder(),10),document.title=this.exe.ref.textContent.split("\n")[0].substring(0,32),this.provider.clear();var t=document.title;t=s.escapeUnkown(t),t+=".rtn";var r='{\n  "how_to_open": "Visit the link contained in the value of the `.link` property. If no suitable copy of the RTN software exists, see `.data_recovery`.",\n  "link": "{{DATA}}",\n  "data_structure": "Each RTN link consists of 3 URI parameters: `enc=`, `cmpr=`, and `data=`. These stand for `encoding`, `compression`, and `data` respectively. Extraction of these components may be necessary for data recovery.",\n  "data_recovery": "In the event that no copy of the RTN software is available, it is still possible to recover the included data. Data is encoded with the `.encoding` encoding type and compressed with the `.compression` compression scheme. Decode the data attribute into a uInt8 array, then decompress (into another uInt8 array), and then decode using standard text decoding to find the original text. For URI-B64 encoding, replace `-_` with `+/` and then handle with normal base64_decode. For LZMA2 compression, gzinflate data[2:]."\n}';r=r.replace("{{DATA}}",window.link_full),this.provider.provide(t,"text/plain",r)}}pullURL(){return this.uri.pull()}async setURL(e){if(""!=e)this.raw.ref.value=e;else{this.raw.ref.value="Loading...";var t=await fetch("./default.txt");if(!t.ok){console.error(`Failed to fetch default document: ${t.status}`),this.raw.ref.value=`Failed to fetch default document: ${t.status}`;return}this.raw.ref.value=await t.text()}}pushURL(){var e=s.trimTrailingWhitespace(this.exe.ref.textContent);this.exe.tree.input=e,this.exe.tree.totalParse(),e=this.exe.tree.output,e=s.shrinkTreeToFour(e),e=s.revertList(e),this.uri.push(e)}keyPreRouter(e){this.raw.keyHandler(e,e=>this.keyPostRouter(e)),this.urlPreEncodeOnIdle()}keyPostRouter(){this.raw.update(),this.exe.ref.innerHTML=s.escapeHTML(this.raw.ref.value),this.exe.update(),this.syncScrollbars()}handlePaste(e){setTimeout(()=>{this.raw.ref.value=s.treeToTab(this.raw.ref.value)},100),setTimeout(e=>this.syncScrollbars(e),100)}handleCopy(e){e.preventDefault(),this.keyPostRouter();var t=this.raw.ref.selectionStart,r=this.raw.ref.value.substring(0,t),i=f(r),a=this.raw.ref.selectionEnd,n=this.raw.ref.value.substring(t,a),l=f(n),o=this.raw.ref.selectionStart+8*i,d=this.raw.ref.selectionEnd+8*i+8*l,h=this.exe.ref.textContent.substring(o,d);this.exe.tree.input=h,this.exe.tree.totalParse(),h=this.exe.tree.output;let u=localStorage.getItem("RTN-SETTING_param-copyGlyphSize");function f(e){var t=e.match(/\t/gm);return null!=t?t.length:0}h=s.resizeGlyphs(h,u),h=s.revertList(h),h=s.trimTrailingWhitespace(h),navigator.clipboard.writeText(h)}syncScrollbars(e){let t=document.getElementById("display"),r=document.getElementById("source"),i=document.getElementById("main"),s=document.getElementById("header");i.style.top=`${s.offsetHeight+10}px`;let a=`${t.offsetHeight+50}px`,n=`${t.offsetWidth+i.offsetLeft}px`;i.style.height=a,i.style.width=n,r.style.height=`${t.offsetHeight}px`,r.style.width=`${t.offsetWidth+i.offsetLeft}px`,i.style.minWidth=`${s.offsetWidth}px`,r.style.minWidth=`${s.offsetWidth}px`,t.style.minWidth=`${s.offsetWidth}px`}hardFix(){this.raw.update(),this.exe.ref.tree.input=this.raw.ref.value,this.exe.tree.totalParse(),this.exe.update();var e=this.raw.ref.selectionStart,t=this.raw.ref.selectionEnd;this.raw.ref.value=this.exe.tree.content.substring(0,this.exe.tree.content.length-1),this.raw.update(),this.exe.ref.textContent=this.raw.ref.value,this.exe.tree.totalParse(),this.exe.update(),this.raw.ref.selectionStart=e,this.raw.ref.selectionEnd=t}scrollToCaret(e){var t=document.createElement("div");t.style.position="absolute",t.style.color="red",t.style.padding="5px",t.style.wordBreak="normal",t.style.whiteSpace="pre-wrap",t.style.border="solid 0.25vw transparent",t.style.fontSize=document.getElementById("source").style.fontSize,document.getElementById("main").appendChild(t),t.innerHTML=e.value.substring(0,e.selectionEnd)+'<span id="scrollCarrat"></span>',document.getElementById("scrollCarrat").scrollIntoView({behavior:"smooth",block:"center",inline:"end"}),document.getElementById("scrollCarrat").remove(),document.getElementById("main").removeChild(t)}dirnav(e,t,r,i=!1){if(i||e.preventDefault(),!0==document.getElementById("source").hidden){e.preventDefault();return}for(var s=this.raw.ref.value.split("\n"),a=s.length-1,n=r,l=t.split("/").filter(e=>null!=e&&""!==e&&"DNL."!==e&&"RTN."!=e&&"DL."!=e),o={Payload:t,Index:r,Lines:s,LowerBound:0,UpperBound:a,Actions:l};0!=l.length;)switch(l[0]){case"RTN.":case"DNL.":case"DL.":l.shift();break;case"RTN":case"DNL":case"DL":var d=0;if(d<0)return console.debug("DirNav called for invalid Indent Level "+d,o),!1;for(;n>=0&&b(s[n])!=d;)n--;if(n<0)return console.debug("DirNav could not find a proper parent...",o),!1;l.shift();break;case"RTN~":case"DNL~":case"DL~":var d=1;if(d<0)return console.debug("DirNav called for invalid Indent Level "+d,o),!1;for(;n>=0&&b(s[n])!=d;)n--;if(n<0)return console.debug("DirNav could not find a proper parent...",o),!1;l.shift();break;case"..":var d=b(s[n])-1;if(d<0)return console.debug("DirNav called for invalid Indent Level "+d,o),!1;for(;n>=0&&b(s[n])!=d;)n--;if(n<0)return console.debug("DirNav could not find a proper parent...",o),!1;l.shift();break;default:var h=b(s[n]);if(l[0].match(/\[[0-9]*\]/)){for(var u=parseInt(l[0].substring(1,l[0].length-1),10),f=-1;f<u&&n<=a;){if(b(s[++n])<=h)return console.debug("DirNav failed to find a child of index ["+u+"] before exhausting the domain!",o),!1;b(s[n])==h+1&&f++}l.shift()}else{let c=l[0].substring(1,l[0].length-1).replace(/^([^a-zA-Z0-9]*)(.*)/,"$2"),p=RegExp("^\\s*[^a-zA-Z0-9]*"+c+".*");for(;!s[n].match(p)&&n<=a;)if(b(s[++n])<=h){if(c.startsWith("Invalid links will do nothing when clicked"))return!1;return console.debug("DirNav failed to find a child of key ["+c+"] before exhausting the domain!",o),!1}l.shift()}}if(i)return!0;for(var v="",y=0;y<n;y++)v+=s[y]+"\n";var g=(v=v.substring(0,v.length-1)).length,w=s[n].match(/^(\s*)([^\n]*)/),m=w[1].length,$=w[2].length;return this.raw.start=g+m,this.raw.end=g+m+$,0!=this.raw.start&&(this.raw.start++,this.raw.end++),this.raw.ref.focus(),this.raw.writeCarrat(),this.scrollToCaret(this.raw.ref),!0;function b(e){return null==e||""==e?0:e.split("	").length-1}}}